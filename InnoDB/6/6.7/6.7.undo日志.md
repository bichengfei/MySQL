# Undo logs / 撤销日志

<B>不是很明白 undo log，此节暂不完整</B>

一个 undo log 是一个日志记录集合，集合中的元素是与单个读写事务相关联的撤销日志记录。撤销日志记录包含如何撤销最近的事务对聚集索引记录的修改。如果另一个事务需要查看原始数据作为一致性读取操作的一部分，则未修改的数据将从 undo log 中检索。undo log 存在于 `undo log segments` （撤销日志段）中，`undo log segments` 包含在 `rollback segments`（回滚段） 中，`rollback segments` 包含在[系统表空间](../6.3/6.3.表空间.md)、[撤销表空间](../6.3/6.3.表空间.md)和[临时表空间](../6.3/6.3.表空间.md)中。

驻留在临时表空间中的 undo log 用于用户定义的临时表的数据修改事务。这些 undo logs 不会被写入 redo log，因为它们不是崩溃恢复所必须的，它们仅用户服务器运行时的回滚，因为避免写入 redo log ，也提高了性能。

InnoDB 中的回滚段数量，可通过 `innodb_rollback_segments`变量指定，最多支持 128 个回滚段，其中 32 个分配给临时表空间，剩下的 96 个，可以分配给修改常规表中数据的事务。

回滚段支持的事务数量取决于回滚段中 undo slot （撤销槽）的数量和每个事务需要的 undo log 数量。回滚段中的 undo slot 数量因 InnoDB 页面大小而异。

| InnoDB 页面大小 | 回滚段中的 undo slot 数量 |
|:-----------:|:------------------:|
| 4 KB        | 256                |
| 8 KB        | 512                |
| 16 KB       | 1024               |
| 32 KB       | 2048               |
| 64 KB       | 4096               |

一个事务最多分配四个 undo log，分别对应以下每种操作类型：

1. 对用户定义表的 insert 
2. 对用户定义表的 update 以及  delete 操作
3. 对用户定义的临时表的 insert 操作
4. 对用户定义的临时表的 update 以及 delete 操作
